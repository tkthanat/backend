CREATE DATABASE IF NOT EXISTS attendance_db
  CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE attendance_db;

-- 1) ประเภทผู้ใช้
DROP TABLE IF EXISTS user_types;
CREATE TABLE user_types (
  user_type_id INT AUTO_INCREMENT PRIMARY KEY,
  type_name VARCHAR(50) NOT NULL UNIQUE
) ENGINE=InnoDB;

-- 2) วิชา / คอร์ส
DROP TABLE IF EXISTS subjects;
CREATE TABLE subjects (
  subject_id INT AUTO_INCREMENT PRIMARY KEY,
  subject_name VARCHAR(255) NOT NULL,
  section VARCHAR(100),
  schedule VARCHAR(255),
  UNIQUE KEY uq_subject (subject_name, section)
) ENGINE=InnoDB;

-- 3) ผู้ใช้ในระบบ
DROP TABLE IF EXISTS users;
CREATE TABLE users (
  user_id INT AUTO_INCREMENT PRIMARY KEY,
  student_code VARCHAR(50),
  name VARCHAR(255) NOT NULL,
  role ENUM('admin','operator','viewer') NOT NULL,
  user_type_id INT NULL,
  password_hash VARCHAR(255),
  subject_id INT NULL,
  is_deleted TINYINT(1) DEFAULT 0,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

  FOREIGN KEY (user_type_id) REFERENCES user_types(user_type_id) ON DELETE SET NULL,
  FOREIGN KEY (subject_id) REFERENCES subjects(subject_id) ON DELETE SET NULL,

  INDEX idx_users_student_code (student_code)
) ENGINE=InnoDB;

-- 4) เก็บ path ของรูปจริง (แทน embedding)
DROP TABLE IF EXISTS user_faces;
CREATE TABLE user_faces (
  face_id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NOT NULL,
  file_path VARCHAR(512) NOT NULL,    -- path ของรูปในเครื่องหรือ server
  captured_at DATETIME DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
  UNIQUE KEY uq_user_faces_path (file_path),
  INDEX idx_user_faces_user (user_id)
) ENGINE=InnoDB;

-- 5) Log การเข้า–ออก
DROP TABLE IF EXISTS attendance_logs;
CREATE TABLE attendance_logs (
  log_id INT AUTO_INCREMENT PRIMARY KEY,
  user_id INT NULL,
  subject_id INT NULL,
  action ENUM('enter','exit') NOT NULL,
  timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
  confidence FLOAT,
  flags JSON NULL,

  FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE SET NULL,
  FOREIGN KEY (subject_id) REFERENCES subjects(subject_id) ON DELETE SET NULL,

  INDEX idx_logs_timestamp (timestamp)
) ENGINE=InnoDB;

-- 6) แจ้งเตือนเหตุผิดปกติ
DROP TABLE IF EXISTS alerts;
CREATE TABLE alerts (
  alert_id INT AUTO_INCREMENT PRIMARY KEY,
  log_id INT NOT NULL,
  type ENUM('short_stay','multiple_faces','low_confidence','spoofing') NOT NULL,
  confidence FLOAT,
  status ENUM('open','approved','rejected') DEFAULT 'open',

  FOREIGN KEY (log_id) REFERENCES attendance_logs(log_id) ON DELETE CASCADE
) ENGINE=InnoDB;

-- Done.
